<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Γραμματεία Dashboard</title>
    <link rel="stylesheet" href="/css/style.css">
    <style>
        .dashboard-container {
            width: 95%;
            max-width: 1400px;
            margin: 20px auto;
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .section-content {
            margin-top: 20px;
            border-top: 1px solid #eee;
            padding-top: 20px;
        }
        .thesis-card {
            background-color: #f9f9f9;
            border: 1px solid #ddd;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 6px;
        }
        .thesis-card h4 {
            margin-top: 0;
            margin-bottom: 10px;
            color: #007bff;
        }
        .thesis-card p {
            margin-bottom: 5px;
            font-size: 0.9em;
        }
        .thesis-actions {
            margin-top: 10px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .thesis-actions button {
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85em;
        }
        .thesis-actions .gs-btn { background-color: #28a745; color: white; }
        .thesis-actions .cancel-btn { background-color: #dc3545; color: white; }
        .thesis-actions .complete-btn { background-color: #007bff; color: white; }

        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
        }
        .modal-content {
            background-color: #fefefe;
            margin: 10% auto; /* 10% from the top and centered */
            padding: 20px;
            border: 1px solid #888;
            width: 50%; /* Adjust as needed */
            border-radius: 8px;
            position: relative;
        }
        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            position: absolute;
            top: 10px;
            right: 20px;
        }
        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <div class="dashboard-header">
            <h2 id="welcomeMessage">Γραμματεία Dashboard</h2>
            <button onclick="logout()">Αποσύνδεση</button>
        </div>

        <nav>
            <a href="#active-theses-section">Ενεργές Διπλωματικές</a> |
            <a href="#under-review-theses-section">Διπλωματικές Υπό Εξέταση</a> |
            <a href="#data-import-section">Εισαγωγή Δεδομένων</a>
        </nav>

        <section id="active-theses-section" class="section-content">
            <h3>Ενεργές Διπλωματικές Εργασίες</h3>
            <div id="activeThesesList">
                <p>Φόρτωση ενεργών διπλωματικών...</p>
            </div>
        </section>

        <section id="under-review-theses-section" class="section-content" style="display: none;">
            <h3>Διπλωματικές Εργασίες Υπό Εξέταση</h3>
            <div id="underReviewThesesList">
                <p>Φόρτωση υπό εξέταση διπλωματικών...</p>
            </div>
        </section>

        <section id="data-import-section" class="section-content" style="display: none;">
            <h3>Εισαγωγή Δεδομένων</h3>
            <p>Εδώ θα υλοποιηθεί η εισαγωγή αρχείου JSON με προσωπικές πληροφορίες φοιτητών και διδασκόντων.</p>
            <form id="importDataForm">
                <div class="form-group">
                    <label for="jsonFile">Επιλογή αρχείου JSON:</label>
                    <input type="file" id="jsonFile" name="jsonFile" accept=".json" disabled>
                </div>
                <button type="submit" disabled>Εισαγωγή</button>
                <p id="importMessage" class="error-message"></p>
            </form>
            <p>Δείτε τον σύνδεσμο για παράδειγμα JSON: <a href="http://usidas.ceid.upatras.gr/web/2024/index.php" target="_blank">http://usidas.ceid.upatras.gr/web/2024/index.php</a></p>
        </section>

        <!-- Modals for actions -->
        <div id="gsApprovalModal" class="modal">
            <div class="modal-content">
                <span class="close-button" onclick="closeModal('gsApprovalModal')">&times;</span>
                <h4>Καταχώριση Αριθμού Πρωτοκόλλου Γ.Σ.</h4>
                <form id="gsApprovalForm">
                    <input type="hidden" id="gsApprovalThesisId">
                    <div class="form-group">
                        <label for="gsProtocolInput">Αριθμός Πρωτοκόλλου Γ.Σ.:</label>
                        <input type="text" id="gsProtocolInput" name="gs_protocol" required>
                    </div>
                    <button type="submit">Αποθήκευση</button>
                    <p id="gsApprovalMessage" class="error-message"></p>
                </form>
            </div>
        </div>

        <div id="cancelThesisModal" class="modal">
            <div class="modal-content">
                <span class="close-button" onclick="closeModal('cancelThesisModal')">&times;</span>
                <h4>Ακύρωση Διπλωματικής Εργασίας</h4>
                <form id="cancelThesisForm">
                    <input type="hidden" id="cancelThesisId">
                    <div class="form-group">
                        <label for="gsNumberInput">Αριθμός Γ.Σ. Ακύρωσης:</label>
                        <input type="text" id="gsNumberInput" name="gs_number" required>
                    </div>
                    <div class="form-group">
                        <label for="gsYearInput">Έτος Γ.Σ. Ακύρωσης:</label>
                        <input type="number" id="gsYearInput" name="gs_year" required>
                    </div>
                    <div class="form-group">
                        <label for="cancelReasonInput">Λόγος Ακύρωσης:</label>
                        <textarea id="cancelReasonInput" name="reason" rows="4" required></textarea>
                    </div>
                    <button type="submit">Ακύρωση Διπλωματικής</button>
                    <p id="cancelThesisMessage" class="error-message"></p>
                </form>
            </div>
        </div>

    </div>

    <script>
        let allSecretariatTheses = []; // Global variable to store fetched theses

        document.addEventListener('DOMContentLoaded', () => {
            fetchUserInfo();
            fetchSecretariatTheses();

            // Navigation logic
            document.querySelectorAll('nav a').forEach(link => {
                link.addEventListener('click', (event) => {
                    event.preventDefault();
                    document.querySelectorAll('section').forEach(section => {
                        section.style.display = 'none';
                    });
                    const targetSection = document.querySelector(event.target.getAttribute('href'));
                    if (targetSection) {
                        targetSection.style.display = 'block';
                    }
                    // Re-render lists if needed when switching sections
                    if (event.target.getAttribute('href') === '#active-theses-section') {
                        renderThesesList(allSecretariatTheses.filter(t => t.status === 'active'), 'activeThesesList');
                    } else if (event.target.getAttribute('href') === '#under-review-theses-section') {
                        renderThesesList(allSecretariatTheses.filter(t => t.status === 'under_review'), 'underReviewThesesList');
                    }
                });
            });

            // Form submissions for modals
            document.getElementById('gsApprovalForm').addEventListener('submit', handleGsApprovalSubmit);
            document.getElementById('cancelThesisForm').addEventListener('submit', handleCancelThesisSubmit);
        });

        async function fetchUserInfo() {
            try {
                const response = await fetch('/api/user-info');
                if (response.ok) {
                    const data = await response.json();
                    if (data.userName) {
                        document.getElementById('welcomeMessage').textContent = `Καλώς Ορίσατε, ${data.userName}!`;
                    }
                }
            } catch (err) {
                console.error('Could not fetch user info:', err);
            }
        }

        async function fetchSecretariatTheses() {
            try {
                const response = await fetch('/api/secretariat/theses');
                if (response.ok) {
                    allSecretariatTheses = await response.json(); // Store all theses
                    renderThesesList(allSecretariatTheses.filter(t => t.status === 'active'), 'activeThesesList');
                    renderThesesList(allSecretariatTheses.filter(t => t.status === 'under_review'), 'underReviewThesesList');
                } else {
                    const errorData = await response.json();
                    document.getElementById('activeThesesList').innerHTML = `<p style="color: red;">Σφάλμα φόρτωσης διπλωματικών: ${errorData.message}</p>`;
                    document.getElementById('underReviewThesesList').innerHTML = `<p style="color: red;">Σφάλμα φόρτωσης διπλωματικών: ${errorData.message}</p>`;
                }
            } catch (error) {
                console.error('Error fetching secretariat theses:', error);
                document.getElementById('activeThesesList').innerHTML = `<p style="color: red;">Αδυναμία επικοινωνίας με τον server.</p>`;
                document.getElementById('underReviewThesesList').innerHTML = `<p style="color: red;">Αδυναμία επικοινωνίας με τον server.</p>`;
            }
        }

        function renderThesesList(theses, containerId) {
            const container = document.getElementById(containerId);
            container.innerHTML = ''; // Clear previous content

            if (theses.length === 0) {
                container.innerHTML = '<p>Δεν υπάρχουν διπλωματικές εργασίες σε αυτή την κατάσταση.</p>';
                return;
            }

            theses.forEach(thesis => {
                const thesisCard = document.createElement('div');
                thesisCard.className = 'thesis-card';
                thesisCard.innerHTML = `
                    <h4>${escapeHtml(thesis.title)}</h4>
                    <p><strong>Φοιτητής:</strong> ${escapeHtml(thesis.student_name || 'N/A')} ${escapeHtml(thesis.student_surname || '')} (${escapeHtml(thesis.student_email || 'N/A')})</p>
                    <p><strong>Επιβλέπων:</strong> ${escapeHtml(thesis.supervisor_name)} ${escapeHtml(thesis.supervisor_surname)} (${escapeHtml(thesis.supervisor_email)})</p>
                    <p><strong>Κατάσταση:</strong> ${translateThesisStatus(thesis.status)}</p>
                    ${thesis.assignment_date ? `<p><strong>Ημερομηνία Ανάθεσης:</strong> ${new Date(thesis.assignment_date).toLocaleDateString('el-GR')}</p>` : ''}
                    ${thesis.gs_approval_protocol ? `<p><strong>ΑΠ Γ.Σ. Ανάθεσης:</strong> ${escapeHtml(thesis.gs_approval_protocol)}</p>` : ''}
                    ${thesis.status === 'under_review' && thesis.final_grade ? `<p><strong>Τελικός Βαθμός:</strong> ${thesis.final_grade}</p>` : ''}
                    ${thesis.status === 'under_review' && thesis.repository_url ? `<p><strong>Σύνδεσμος Αποθετηρίου:</strong> <a href="${escapeHtml(thesis.repository_url)}" target="_blank">View</a></p>` : ''}
                    ${thesis.cancellation_reason ? `<p style="color: red;"><strong>Ακυρώθηκε:</strong> ${escapeHtml(thesis.cancellation_reason)}</p>` : ''}

                    <div class="thesis-actions">
                        ${thesis.status === 'active' && !thesis.gs_approval_protocol ? `<button class="gs-btn" onclick="openGsApprovalModal(${thesis.id})">Καταχώριση ΑΠ Γ.Σ.</button>` : ''}
                        ${thesis.status === 'active' || thesis.status === 'under_review' ? `<button class="cancel-btn" onclick="openCancelThesisModal(${thesis.id})">Ακύρωση Διπλωματικής</button>` : ''}
                        ${thesis.status === 'under_review' && thesis.final_grade !== null && thesis.repository_url !== null ? `<button class="complete-btn" onclick="completeThesis(${thesis.id})">Ολοκλήρωση Διπλωματικής</button>` : '<p style="font-size: 0.8em; color: #888;">(Για ολοκλήρωση απαιτούνται βαθμός και σύνδεσμος αποθετηρίου)</p>'}
                    </div>
                `;
                container.appendChild(thesisCard);
            });
        }

        function translateThesisStatus(status) {
            const statusMap = {
                'available': 'Διαθέσιμη',
                'under_assignment': 'Υπό Ανάθεση',
                'active': 'Ενεργή',
                'under_review': 'Υπό Εξέταση',
                'completed': 'Ολοκληρωμένη',
                'cancelled': 'Ακυρωμένη'
            };
            return statusMap[status] || status;
        }

        function openGsApprovalModal(thesisId) {
            document.getElementById('gsApprovalThesisId').value = thesisId;
            document.getElementById('gsProtocolInput').value = ''; // Clear previous input
            document.getElementById('gsApprovalMessage').textContent = '';
            document.getElementById('gsApprovalModal').style.display = 'block';
        }

        async function handleGsApprovalSubmit(event) {
            event.preventDefault();
            const thesisId = document.getElementById('gsApprovalThesisId').value;
            const gsProtocol = document.getElementById('gsProtocolInput').value;

            try {
                const response = await fetch(`/api/secretariat/theses/${thesisId}/gs-approval`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ gs_protocol: gsProtocol })
                });
                const result = await response.json();
                const messageElement = document.getElementById('gsApprovalMessage');

                if (response.ok) {
                    messageElement.textContent = result.message;
                    messageElement.style.color = 'green';
                    fetchSecretariatTheses(); // Refresh list
                    setTimeout(() => closeModal('gsApprovalModal'), 1500);
                } else {
                    messageElement.textContent = result.message || 'Σφάλμα καταχώρισης ΑΠ Γ.Σ.';
                    messageElement.style.color = 'red';
                }
            } catch (error) {
                console.error('Error updating GS approval:', error);
                document.getElementById('gsApprovalMessage').textContent = 'Αδυναμία επικοινωνίας με τον server.';
                document.getElementById('gsApprovalMessage').style.color = 'red';
            }
        }

        function openCancelThesisModal(thesisId) {
            document.getElementById('cancelThesisId').value = thesisId;
            document.getElementById('gsNumberInput').value = '';
            document.getElementById('gsYearInput').value = new Date().getFullYear(); // Default to current year
            document.getElementById('cancelReasonInput').value = '';
            document.getElementById('cancelThesisMessage').textContent = '';
            document.getElementById('cancelThesisModal').style.display = 'block';
        }

        async function handleCancelThesisSubmit(event) {
            event.preventDefault();
            const thesisId = document.getElementById('cancelThesisId').value;
            const gsNumber = document.getElementById('gsNumberInput').value;
            const gsYear = document.getElementById('gsYearInput').value;
            const reason = document.getElementById('cancelReasonInput').value;

            try {
                const response = await fetch(`/api/secretariat/theses/${thesisId}/cancel`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ gs_number: gsNumber, gs_year: gsYear, reason: reason })
                });
                const result = await response.json();
                const messageElement = document.getElementById('cancelThesisMessage');

                if (response.ok) {
                    messageElement.textContent = result.message;
                    messageElement.style.color = 'green';
                    fetchSecretariatTheses(); // Refresh list
                    setTimeout(() => closeModal('cancelThesisModal'), 1500);
                } else {
                    messageElement.textContent = result.message || 'Σφάλμα ακύρωσης διπλωματικής.';
                    messageElement.style.color = 'red';
                }
            } catch (error) {
                console.error('Error cancelling thesis:', error);
                document.getElementById('cancelThesisMessage').textContent = 'Αδυναμία επικοινωνίας με τον server.';
                document.getElementById('cancelThesisMessage').style.color = 'red';
            }
        }

        async function completeThesis(thesisId) {
            if (!confirm('Είστε σίγουροι ότι θέλετε να ολοκληρώσετε αυτή τη διπλωματική; Βεβαιωθείτε ότι έχουν καταχωρηθεί βαθμός και σύνδεσμος αποθετηρίου.')) {
                return;
            }
            try {
                const response = await fetch(`/api/secretariat/theses/${thesisId}/complete`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' }
                });
                const result = await response.json();
                alert(result.message); // Simple alert for completion
                if (response.ok) {
                    fetchSecretariatTheses(); // Refresh list
                }
            } catch (error) {
                console.error('Error completing thesis:', error);
                alert('Αδυναμία επικοινωνίας με τον server για ολοκλήρωση διπλωματικής.');
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function escapeHtml(text) {
            if (typeof text !== 'string') return text;
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, function(m) { return map[m]; });
        }

        async function logout() {
            try {
                const response = await fetch('/logout', { method: 'POST' });
                if (response.ok) {
                    window.location.href = '/login.html';
                } else {
                    alert('Σφάλμα αποσύνδεσης.');
                }
            } catch (error) {
                console.error('Error during logout:', error);
                alert('Αδυναμία αποσύνδεσης.');
            }
        }
    </script>
</body>
</html>