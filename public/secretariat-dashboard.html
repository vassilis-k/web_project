<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Γραμματεία - Dashboard</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <div class="white-line-top">
        <div class="logo-top-left">
            <img src="/img/upatras-logo.png" alt="University of Patras Logo">
        </div>
        <div class="header-text-top-right">
            <div style="display: flex; align-items: center; gap: 16px;">
                <div class="header-buttons-inline" style="margin-right: 24px;">
                    <button class="logout-header-btn" onclick="logout()">Αποσύνδεση</button>
                </div>
                <div class="main-title">Σύστημα Υποστήριξης Διπλωματικών Εργασιών</div>
            </div>
            <div class="subtitle">Πανεπιστήμιο Πατρών</div>
        </div>
    </div>
    <div class="main-wrapper">
        <div class="student-dashboard-container">
        <div class="student-dashboard-header">
            <h2 id="welcomeMessage">Καλωσήρθατε!</h2>
        </div>
        <nav class="student-dashboard-nav">
            <button class="student-dashboard-nav-btn" onclick="showSection('active-theses-section')">Ενεργές Διπλωματικές</button>
            <button class="student-dashboard-nav-btn" onclick="showSection('data-import-section')">Εισαγωγή Δεδομένων</button>
        </nav>

        <section id="active-theses-section" class="student-section-content">
            <h3>Ενεργές Διπλωματικές & Διπλωματικές Υπό Εξέταση</h3>
            <div id="thesesList">
                <p>Φόρτωση διπλωματικών...</p>
            </div>
        </section>

        <section id="data-import-section" class="student-section-content" style="display: none;">
            <h3>Εισαγωγή Δεδομένων</h3>
            <p>Ανεβάστε ένα αρχείο JSON για να εισαγάγετε μαζικά τις προσωπικές πληροφορίες των φοιτητών και των διδασκόντων.</p>
            <form id="importDataForm">
                <div class="form-group">
                    <label for="jsonFile">Επιλογή αρχείου JSON:</label>
                    <input type="file" id="jsonFile" name="jsonFile" accept=".json">
                </div>
                <button type="submit">Εισαγωγή</button>
                <p id="importMessage" class="message"></p>
            </form>
            <p>Δείτε τον σύνδεσμο για παράδειγμα JSON: <a href="http://usidas.ceid.upatras.gr/web/2024/index.php" target="_blank">http://usidas.ceid.upatras.gr/web/2024/index.php</a></p>
        </section>

        <!-- Modal for Thesis Details -->
        <div id="thesisDetailsModal" class="modal">
            <div class="modal-content">
                <span class="close-button" onclick="closeModal('thesisDetailsModal')">&times;</span>
                <div id="thesisDetailsContent">
                    <!-- Details will be loaded here -->
                </div>
            </div>
        </div>
    </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            fetchUserInfo();
            fetchSecretariatTheses();
            
            // Show the first section by default and set active button
            showSection('active-theses-section');

            // Navigation logic
            document.querySelectorAll('.student-dashboard-nav-btn').forEach(btn => {
                btn.addEventListener('click', (event) => {
                    const sectionId = event.target.getAttribute('onclick').match(/'([^']+)'/)[1];
                    showSection(sectionId);
                });
            });

            document.getElementById('importDataForm').addEventListener('submit', handleDataImport);
            
            // Show first section by default
            showSection('active-theses-section');
        });

        async function handleDataImport(event) {
            event.preventDefault();
            const form = event.target;
            const fileInput = document.getElementById('jsonFile');
            const messageElement = document.getElementById('importMessage');
            const file = fileInput.files[0];

            if (!file) {
                messageElement.textContent = 'Παρακαλώ επιλέξτε ένα αρχείο.';
                messageElement.className = 'error-message';
                return;
            }

            const formData = new FormData();
            formData.append('jsonFile', file);

            messageElement.textContent = 'Γίνεται εισαγωγή...';
            messageElement.className = 'message';

            try {
                const response = await fetch('/api/secretariat/import-users', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (response.ok) {
                    messageElement.textContent = result.message;
                    messageElement.className = 'success-message';
                    form.reset();
                } else {
                    messageElement.textContent = `Σφάλμα: ${result.message}`;
                    messageElement.className = 'error-message';
                }
            } catch (error) {
                console.error('Error importing data:', error);
                messageElement.textContent = 'Σφάλμα κατά την επικοινωνία με τον server.';
                messageElement.className = 'error-message';
            }
        }

        async function fetchUserInfo() {
            try {
                const response = await fetch('/api/user-info');
                if (response.ok) {
                    const data = await response.json();
                    if (data.userName) {
                        document.getElementById('welcomeMessage').textContent = `Καλώς Ορίσατε, ${data.userName}!`;
                    }
                }
            } catch (err) {
                console.error('Could not fetch user info:', err);
            }
        }

        async function fetchSecretariatTheses() {
            try {
                const response = await fetch('/api/secretariat/theses-overview');
                const thesesListDiv = document.getElementById('thesesList');
                if (response.ok) {
                    const theses = await response.json();
                    renderThesesList(theses, 'thesesList');
                } else {
                    const errorData = await response.json();
                    thesesListDiv.innerHTML = `<p style="color: red;">Σφάλμα φόρτωσης διπλωματικών: ${errorData.message}</p>`;
                }
            } catch (error) {
                console.error('Error fetching secretariat theses:', error);
                document.getElementById('thesesList').innerHTML = `<p style="color: red;">Αδυναμία επικοινωνίας με τον server.</p>`;
            }
        }

        function renderThesesList(theses, containerId) {
            const container = document.getElementById(containerId);
            container.innerHTML = ''; // Clear previous content

            if (theses.length === 0) {
                container.innerHTML = '<p>Δεν υπάρχουν διπλωματικές εργασίες σε κατάσταση "Ενεργή" ή "Υπό Εξέταση".</p>';
                return;
            }

            const table = document.createElement('table');
            table.className = 'theses-table';
            table.innerHTML = `
                <thead>
                    <tr>
                        <th>Τίτλος</th>
                        <th>Φοιτητής</th>
                        <th>Επιβλέπων</th>
                        <th>Κατάσταση</th>
                        <th>Ενέργειες</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            `;
            const tbody = table.querySelector('tbody');

            theses.forEach(thesis => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${escapeHtml(thesis.title)}</td>
                    <td>${escapeHtml(thesis.student_name)} ${escapeHtml(thesis.student_surname)}</td>
                    <td>${escapeHtml(thesis.supervisor_name)} ${escapeHtml(thesis.supervisor_surname)}</td>
                    <td>${translateThesisStatus(thesis.status)}</td>
                    <td><button onclick='openThesisDetailsModal(${JSON.stringify(thesis)})'>Προβολή</button></td>
                `;
            });

            container.appendChild(table);
        }

        function openThesisDetailsModal(thesis) {
            const contentDiv = document.getElementById('thesisDetailsContent');

            let committeeHtml = '<h4>Μέλη Επιτροπής</h4><p>Δεν έχουν οριστεί ακόμη.</p>';
            if (thesis.committee_members && thesis.committee_members.length > 0) {
                committeeHtml = `
                    <h4>Μέλη Επιτροπής</h4>
                    <ul>
                        ${thesis.committee_members.map(m => `<li>${escapeHtml(m.name)} ${escapeHtml(m.surname)}</li>`).join('')}
                    </ul>
                `;
            }

            let timeElapsedHtml = '';
            if (thesis.assignment_date) {
                const assignmentDate = new Date(thesis.assignment_date);
                const now = new Date();
                const diffTime = Math.abs(now - assignmentDate);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                const diffMonths = (now.getFullYear() - assignmentDate.getFullYear()) * 12 + (now.getMonth() - assignmentDate.getMonth());
                timeElapsedHtml = `<p><strong>Χρόνος από την ανάθεση:</strong> ${diffDays} ημέρες (~${diffMonths} μήνες)</p>`;
            }

            let managementActionsHtml = generateManagementActions(thesis);


            contentDiv.innerHTML = `
                <h3>${escapeHtml(thesis.title)}</h3>
                <p><strong>Περιγραφή:</strong> ${escapeHtml(thesis.description) || 'Δεν υπάρχει διαθέσιμη περιγραφή.'}</p>
                <p><strong>Κατάσταση:</strong> ${translateThesisStatus(thesis.status)}</p>
                ${timeElapsedHtml}
                ${committeeHtml}
                <div class="modal-actions">
                    ${managementActionsHtml}
                </div>
                <div id="modalActionMessage" class="message" style="display: none;"></div>
            `;

            document.getElementById('thesisDetailsModal').style.display = 'block';
        }

        function generateManagementActions(thesis) {
            let actionsHtml = '<h4>Διαχείριση Διπλωματικής</h4>';

            if (thesis.status === 'active') {
                actionsHtml += `
                    <div class="action-form">
                        <h5>Καταχώριση Αριθμού Πρωτοκόλλου Γ.Σ.</h5>
                        <form onsubmit="handleGsProtocolSubmit(event, ${thesis.id})">
                            <div class="form-group">
                                <label for="gs_protocol">Αριθμός Πρωτοκόλλου:</label>
                                <input type="text" id="gs_protocol" name="gs_protocol" required>
                            </div>
                            <button type="submit">Καταχώριση ΑΠ</button>
                        </form>
                    </div>
                    <div class="action-form">
                        <h5>Ακύρωση Ανάθεσης Διπλωματικής</h5>
                        <form onsubmit="handleCancelThesisSubmit(event, ${thesis.id})">
                            <div class="form-group">
                                <label for="gs_number">Αριθμός Γ.Σ.:</label>
                                <input type="text" id="gs_number" name="gs_number" required>
                            </div>
                            <div class="form-group">
                                <label for="gs_year">Έτος Γ.Σ.:</label>
                                <input type="number" id="gs_year" name="gs_year" value="${new Date().getFullYear()}" required>
                            </div>
                            <div class="form-group">
                                <label for="reason">Λόγος Ακύρωσης:</label>
                                <textarea id="reason" name="reason" rows="3" required></textarea>
                            </div>
                            <button type="submit" class="danger-btn">Ακύρωση Διπλωματικής</button>
                        </form>
                    </div>
                `;
            } else if (thesis.status === 'under_review') {
                actionsHtml += `
                    <div class="action-form">
                        <h5>Ολοκλήρωση Διπλωματικής</h5>
                        <p>Πατήστε το κουμπί για να αλλάξετε την κατάσταση της διπλωματικής σε "Περατωμένη".</p>
                        <p class="small-notice">Αυτό είναι εφικτό μόνο αν έχει καταχωρηθεί βαθμός και ο φοιτητής έχει αναρτήσει τον σύνδεσμο προς το αποθετήριο.</p>
                        <button onclick="handleCompleteThesis(${thesis.id})">Ολοκλήρωση σε "Περατωμένη"</button>
                    </div>
                `;
            } else {
                actionsHtml += '<p>Δεν υπάρχουν διαθέσιμες ενέργειες για αυτή την κατάσταση.</p>';
            }

            return actionsHtml;
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        async function handleGsProtocolSubmit(event, thesisId) {
            event.preventDefault();
            const form = event.target;
            const gs_protocol = form.querySelector('[name="gs_protocol"]').value;
            await handleThesisAction(
                `/api/secretariat/theses/${thesisId}/gs-approval`,
                'PUT',
                { gs_protocol },
                'Ο Αριθμός Πρωτοκόλλου καταχωρήθηκε επιτυχώς!'
            );
        }

        async function handleCancelThesisSubmit(event, thesisId) {
            event.preventDefault();
            const form = event.target;
            const gs_number = form.querySelector('[name="gs_number"]').value;
            const gs_year = form.querySelector('[name="gs_year"]').value;
            const reason = form.querySelector('[name="reason"]').value;
            await handleThesisAction(
                `/api/secretariat/theses/${thesisId}/cancel`,
                'PUT',
                { gs_number, gs_year, reason },
                'Η διπλωματική ακυρώθηκε επιτυχώς.'
            );
        }

        async function handleCompleteThesis(thesisId) {
            await handleThesisAction(
                `/api/secretariat/theses/${thesisId}/complete`,
                'PUT',
                {},
                'Η διπλωματική ολοκληρώθηκε και η κατάστασή της άλλαξε σε "Περατωμένη".'
            );
        }

        async function handleThesisAction(url, method, body, successMessage) {
            const messageElement = document.getElementById('modalActionMessage');
            messageElement.style.display = 'block';
            messageElement.className = 'message';
            messageElement.textContent = 'Επεξεργασία...';

            try {
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });

                const result = await response.json();

                if (response.ok) {
                    messageElement.className = 'success-message';
                    messageElement.textContent = successMessage;
                    // Refresh the list of theses to show the updated status
                    fetchSecretariatTheses(); 
                    // Optionally close the modal after a delay
                    setTimeout(() => closeModal('thesisDetailsModal'), 2000);
                } else {
                    messageElement.className = 'error-message';
                    messageElement.textContent = `Σφάλμα: ${result.message}`;
                }
            } catch (error) {
                messageElement.className = 'error-message';
                messageElement.textContent = 'Σφάλμα επικοινωνίας με τον server.';
                console.error('Thesis action error:', error);
            }
        }

        function translateThesisStatus(status) {
            const statusMap = {
                'available': 'Διαθέσιμη',
                'under_assignment': 'Υπό Ανάθεση',
                'active': 'Ενεργή',
                'under_review': 'Υπό Εξέταση',
                'completed': 'Ολοκληρωμένη',
                'cancelled': 'Ακυρωμένη'
            };
            return statusMap[status] || status;
        }

        function escapeHtml(text) {
            if (typeof text !== 'string') return text;
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, function(m) { return map[m]; });
        }

        async function logout() {
            try {
                const response = await fetch('/logout', { method: 'POST' });
                if (response.ok) {
                    window.location.href = '/login.html';
                } else {
                    alert('Σφάλμα αποσύνδεσης.');
                }
            } catch (error) {
                console.error('Error during logout:', error);
                alert('Αδυναμία αποσύνδεσης.');
            }
        }

        function showSection(sectionId) {
            // Hide all sections
            document.querySelectorAll('.student-section-content').forEach(section => {
                section.style.display = 'none';
            });

            // Remove active class from all nav buttons
            document.querySelectorAll('.student-dashboard-nav-btn').forEach(button => {
                button.classList.remove('active');
            });

            // Show the selected section
            const targetSection = document.getElementById(sectionId);
            if (targetSection) {
                targetSection.style.display = 'block';
            }

            // Add active class to the corresponding button
            const activeButton = document.querySelector(`[onclick="showSection('${sectionId}')"]`);
            if (activeButton) {
                activeButton.classList.add('active');
            }
        }
    </script>
</body>
</html>